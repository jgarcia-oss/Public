<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berrios Debt Protection Analytics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        
        .dashboard-card {
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Chart Container Strict Styling */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (min-width: 1024px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .gradient-text {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>

    <!-- Placeholder Comments -->
    <!-- Chosen Palette: Corporate Trust & Analytics. Primary: Blue-700/600 (Trust, Finance). Secondary: Slate-50/100 (Clean Background). Accent: Emerald-500 (Positive financial indicators) and Amber-500 (Alerts/Debt). -->
    <!-- Application Structure Plan: Dashboard Layout. 
         1. Top Bar: Global controls (Data Upload, Date Filters).
         2. Executive Summary (KPIs): Immediate view of high-level financial health (Total Balance, Premiums, Account Count).
         3. Main Grid:
            - Row 1: Geographic Analysis (Where is the risk?) & Demographic Analysis (Who is the customer?).
            - Row 2: Product Performance (Which plan drives revenue/risk?).
         4. Data Grid: Detailed view for granular inspection.
         Rationale: Executives need the big picture first (KPIs), then context (Location/Person), then specifics (Product). -->
    <!-- Visualization & Content Choices:
         - KPIs: Simple Number Cards. Goal: Instant status check.
         - Geography: Horizontal Bar Chart. Goal: Compare city performance. (Map data is complex without SVG/GeoJSON, bar chart is clearer for ranking).
         - Demographics: Histogram for Age. Goal: Understand risk profile.
         - Product Mix: Doughnut Chart. Goal: Show portfolio composition.
         - Financial Trends: Scatter Plot (Balance vs Premium). Goal: Identify outliers.
         - Library: Chart.js for all visualizations due to responsiveness and canvas rendering. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="text-slate-800">

    <!-- Top Navigation & Control Bar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                        P
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 tracking-tight">Premier Analytics</h1>
                        <p class="text-xs text-slate-500">Berrios Debt Protection Portfolio</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="loadDemoData()" class="px-4 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors border border-blue-200">
                        <i class="fa-solid fa-play mr-2"></i>Load Demo Data
                    </button>
                    <div class="relative">
                        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
                        <label for="csvInput" class="cursor-pointer px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center">
                            <i class="fa-solid fa-upload mr-2"></i> Upload CSV
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Intro / Context Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Portfolio Overview</h2>
            <p class="text-slate-600 max-w-3xl leading-relaxed">
                This dashboard provides an in-depth analysis of the Berrios debt protection portfolio. 
                Use the interactive charts below to evaluate <strong>current exposure</strong>, 
                identify <strong>demographic trends</strong>, and assess performance across 
                <strong>geographic regions</strong> in Puerto Rico.
            </p>
        </div>

        <!-- KPI Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- KPI 1 -->
            <div class="dashboard-card bg-white rounded-xl p-6 border border-slate-100 shadow-sm relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Active Accounts</p>
                        <h3 class="text-3xl font-bold text-slate-900 mt-1" id="kpi-total-accounts">-</h3>
                    </div>
                    <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                        <i class="fa-solid fa-users text-xl"></i>
                    </div>
                </div>
                <p class="text-sm text-slate-400">Total enrollment volume</p>
            </div>

            <!-- KPI 2 -->
            <div class="dashboard-card bg-white rounded-xl p-6 border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Current Balance</p>
                        <h3 class="text-3xl font-bold text-slate-900 mt-1" id="kpi-total-balance">-</h3>
                    </div>
                    <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
                        <i class="fa-solid fa-wallet text-xl"></i>
                    </div>
                </div>
                <p class="text-sm text-slate-400">Aggregate debt exposure</p>
            </div>

            <!-- KPI 3 -->
            <div class="dashboard-card bg-white rounded-xl p-6 border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-amber-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Avg. Balance / Acct</p>
                        <h3 class="text-3xl font-bold text-slate-900 mt-1" id="kpi-avg-balance">-</h3>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-amber-600">
                        <i class="fa-solid fa-chart-line text-xl"></i>
                    </div>
                </div>
                <p class="text-sm text-slate-400">Per customer exposure</p>
            </div>

            <!-- KPI 4 -->
            <div class="dashboard-card bg-white rounded-xl p-6 border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-indigo-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Monthly Premium</p>
                        <h3 class="text-3xl font-bold text-slate-900 mt-1" id="kpi-monthly-premium">-</h3>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
                    </div>
                </div>
                <p class="text-sm text-slate-400">Total recurring revenue</p>
            </div>
        </div>

        <!-- Charts Row 1: Geography & Products -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <!-- Geographic Analysis -->
            <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900">Geographic Exposure</h3>
                        <p class="text-sm text-slate-500">Top 10 Cities by Total Balance</p>
                    </div>
                    <div class="px-3 py-1 bg-slate-100 rounded-full text-xs font-medium text-slate-600">
                        Puerto Rico
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="geoChart"></canvas>
                </div>
                <div class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="text-sm text-slate-700" id="geo-insight">
                        <i class="fa-solid fa-lightbulb text-amber-500 mr-2"></i>
                        Loading geographic insights...
                    </p>
                </div>
            </div>

            <!-- Product Mix -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 flex flex-col">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-slate-900">Product Mix</h3>
                    <p class="text-sm text-slate-500">Enrollment by Plan Code</p>
                </div>
                <div class="chart-container flex-grow flex items-center justify-center">
                    <canvas id="productChart"></canvas>
                </div>
                <div class="mt-auto text-center pt-4">
                    <p class="text-xs text-slate-400">Distribution based on 'Enrollment Plan' field</p>
                </div>
            </div>
        </div>

        <!-- Charts Row 2: Demographics & Correlation -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Age Demographics -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-slate-900">Demographic Profile</h3>
                    <p class="text-sm text-slate-500">Customer Age Distribution</p>
                </div>
                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>
                <div class="mt-4 flex justify-between text-sm text-slate-600 border-t pt-4 border-slate-100">
                    <span>Average Age: <strong id="stat-avg-age">-</strong></span>
                    <span>Youngest: <strong id="stat-min-age">-</strong></span>
                    <span>Oldest: <strong id="stat-max-age">-</strong></span>
                </div>
            </div>

            <!-- Balance Distribution -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-slate-900">Balance Ranges</h3>
                    <p class="text-sm text-slate-500">Distribution of Account Balances</p>
                </div>
                <div class="chart-container">
                    <canvas id="balanceDistChart"></canvas>
                </div>
                <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-100 text-sm text-blue-800">
                    High value accounts (>$2,000) represent <strong id="stat-high-val-perc">-%</strong> of the portfolio.
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-lg font-bold text-slate-900">Recent Account Activity</h3>
                    <p class="text-sm text-slate-500">Detailed view of latest premium transactions</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-500">Sort by:</span>
                    <select id="tableSort" onchange="updateTable()" class="text-sm border-slate-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        <option value="balanceDesc">Balance (High to Low)</option>
                        <option value="balanceAsc">Balance (Low to High)</option>
                        <option value="dateDesc">Date (Newest)</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Account Key</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">City</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Plan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Enrollment Date</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Current Balance</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Premium Due</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200" id="accountsTableBody">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
            <div class="bg-slate-50 px-6 py-3 border-t border-slate-200">
                <p class="text-xs text-slate-500 text-center">Showing top 50 records for performance.</p>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p>&copy; 2025 Premier Insurance and Warranties. Confidential Data Analysis.</p>
            <p class="text-xs mt-2 text-slate-600">Generated for Executive Review.</p>
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- 1. State Management & Data ---
        let rawData = [];
        let charts = {};
        
        // --- 2. Chart Initialization Helper ---
        function initCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';
            
            // Geographic Chart (Bar)
            const ctxGeo = document.getElementById('geoChart').getContext('2d');
            charts.geo = new Chart(ctxGeo, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    indexAxis: 'y', // Horizontal bar
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: true, color: '#f1f5f9' } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Product Chart (Doughnut)
            const ctxProd = document.getElementById('productChart').getContext('2d');
            charts.product = new Chart(ctxProd, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } }
                    },
                    cutout: '70%'
                }
            });

            // Age Chart (Bar/Histogram)
            const ctxAge = document.getElementById('ageChart').getContext('2d');
            charts.age = new Chart(ctxAge, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Balance Dist Chart (Line/Area)
            const ctxBal = document.getElementById('balanceDistChart').getContext('2d');
            charts.balance = new Chart(ctxBal, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    elements: {
                        line: { tension: 0.4 },
                        point: { radius: 2 }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            });
        }

        // --- 3. Data Generation (Demo) ---
        function generateDemoData() {
            const cities = ['SAN JUAN', 'BAYAMON', 'CAROLINA', 'CAGUAS', 'GUAYNABO', 'PONCE', 'ARECIBO', 'MAYAGUEZ', 'TRUJILLO ALTO', 'TOA BAJA', 'GURABO', 'DORADO'];
            const plans = ['ROYAL', '24T2', '36M', 'PLATINUM', 'GOLD'];
            const statuses = ['Active', 'Active', 'Active', 'Cancelled', 'Delinquent']; // Weighted towards Active
            
            const demo = [];
            
            for (let i = 0; i < 500; i++) {
                const enrollmentDate = new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
                const dobYear = 1950 + Math.floor(Math.random() * 50); // Ages approx 25-75
                
                // Simulate Balance based on plan
                const plan = plans[Math.floor(Math.random() * plans.length)];
                let baseBalance = 500;
                if(plan === 'ROYAL') baseBalance = 2000;
                if(plan === 'PLATINUM') baseBalance = 1500;
                
                const balance = baseBalance + (Math.random() * 1000);
                const premium = balance * 0.05; // Approx 5% premium
                
                demo.push({
                    enrollment_account_key: `ACC-${10000 + i}`,
                    enrollment_city: cities[Math.floor(Math.random() * cities.length)],
                    enrollment_state: 'PR',
                    enrollment_splan_code: plan,
                    enrollment_status: statuses[Math.floor(Math.random() * statuses.length)],
                    enrollment_dob: `01/01/${dobYear}`,
                    enrollment_date_report_created: enrollmentDate.toISOString().split('T')[0],
                    premium_clast_month_ending_balance: balance.toFixed(2),
                    premium_ceom_total_due: (Math.random() > 0.8 ? premium : 0).toFixed(2), // 20% have due amount
                    premium_clastmonth_premium_charge: premium.toFixed(2)
                });
            }
            return demo;
        }

        // --- 4. Data Processing & Visualization Update ---
        function processData(data) {
            // 4.1 KPI Calculations
            const totalAccounts = data.length;
            const totalBalance = data.reduce((acc, row) => acc + parseFloat(row.premium_clast_month_ending_balance || 0), 0);
            const totalPremium = data.reduce((acc, row) => acc + parseFloat(row.premium_clastmonth_premium_charge || 0), 0);
            const avgBalance = totalBalance / totalAccounts;

            // Update DOM KPIs
            document.getElementById('kpi-total-accounts').textContent = totalAccounts.toLocaleString();
            document.getElementById('kpi-total-balance').textContent = '$' + totalBalance.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('kpi-avg-balance').textContent = '$' + avgBalance.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('kpi-monthly-premium').textContent = '$' + totalPremium.toLocaleString(undefined, {maximumFractionDigits: 0});

            // 4.2 Geo Data (Top 10 Cities)
            const cityMap = {};
            data.forEach(row => {
                const city = (row.enrollment_city || 'Unknown').toUpperCase().trim();
                cityMap[city] = (cityMap[city] || 0) + parseFloat(row.premium_clast_month_ending_balance || 0);
            });
            const sortedCities = Object.entries(cityMap).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            // Insight for Geo
            const topCity = sortedCities[0];
            document.getElementById('geo-insight').innerHTML = `<i class="fa-solid fa-lightbulb text-amber-500 mr-2"></i> <strong>${topCity[0]}</strong> represents the highest exposure with <strong>$${topCity[1].toLocaleString(undefined, {maximumFractionDigits:0})}</strong> in outstanding balances.`;

            charts.geo.data.labels = sortedCities.map(i => i[0]);
            charts.geo.data.datasets = [{
                label: 'Total Balance',
                data: sortedCities.map(i => i[1]),
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }];
            charts.geo.update();

            // 4.3 Product Data
            const planMap = {};
            data.forEach(row => {
                const plan = (row.enrollment_splan_code || row.enrollment_scard_plan || 'Unknown').trim();
                planMap[plan] = (planMap[plan] || 0) + 1;
            });
            
            charts.product.data.labels = Object.keys(planMap);
            charts.product.data.datasets = [{
                data: Object.values(planMap),
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#6366f1', '#8b5cf6'],
                borderWidth: 0
            }];
            charts.product.update();

            // 4.4 Demographics (Age)
            const ageGroups = {'18-30': 0, '31-40': 0, '41-50': 0, '51-60': 0, '61+': 0};
            let totalAge = 0;
            let countAge = 0;
            let minAge = 100, maxAge = 0;

            data.forEach(row => {
                let dobYear = 0;
                // Parse varying date formats if possible, assuming structure like snippet
                if(row.enrollment_dob && row.enrollment_dob.length >= 4) {
                     // Try simplistic parsing
                     const parts = row.enrollment_dob.match(/(\d{4})/);
                     if(parts) dobYear = parseInt(parts[0]);
                     else if(row.enrollment_dob.split('/').length === 3) dobYear = parseInt(row.enrollment_dob.split('/')[2]);
                }

                if(dobYear > 1900 && dobYear < 2024) {
                    const age = 2026 - dobYear; // Using current context year
                    totalAge += age;
                    countAge++;
                    if(age < minAge) minAge = age;
                    if(age > maxAge) maxAge = age;

                    if (age <= 30) ageGroups['18-30']++;
                    else if (age <= 40) ageGroups['31-40']++;
                    else if (age <= 50) ageGroups['41-50']++;
                    else if (age <= 60) ageGroups['51-60']++;
                    else ageGroups['61+']++;
                }
            });
            
            document.getElementById('stat-avg-age').textContent = countAge ? Math.round(totalAge/countAge) + ' yrs' : '-';
            document.getElementById('stat-min-age').textContent = minAge < 100 ? minAge : '-';
            document.getElementById('stat-max-age').textContent = maxAge > 0 ? maxAge : '-';

            charts.age.data.labels = Object.keys(ageGroups);
            charts.age.data.datasets = [{
                label: 'Customers',
                data: Object.values(ageGroups),
                backgroundColor: '#6366f1',
                borderRadius: 4
            }];
            charts.age.update();

            // 4.5 Balance Distribution (Buckets)
            const buckets = {'< $500': 0, '$500-$1k': 0, '$1k-$2k': 0, '$2k-$5k': 0, '$5k+': 0};
            let highValCount = 0;
            data.forEach(row => {
                const bal = parseFloat(row.premium_clast_month_ending_balance || 0);
                if(bal > 2000) highValCount++;

                if(bal < 500) buckets['< $500']++;
                else if(bal < 1000) buckets['$500-$1k']++;
                else if(bal < 2000) buckets['$1k-$2k']++;
                else if(bal < 5000) buckets['$2k-$5k']++;
                else buckets['$5k+']++;
            });

            document.getElementById('stat-high-val-perc').textContent = ((highValCount/data.length)*100).toFixed(1) + '%';

            charts.balance.data.labels = Object.keys(buckets);
            charts.balance.data.datasets = [{
                label: 'Accounts',
                data: Object.values(buckets),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true
            }];
            charts.balance.update();

            // 4.6 Populate Table
            updateTable(data);
        }

        function updateTable(dataOverride = null) {
            const dataToUse = dataOverride || rawData;
            const sortMode = document.getElementById('tableSort').value;
            const tbody = document.getElementById('accountsTableBody');
            tbody.innerHTML = '';

            // Sort
            const sorted = [...dataToUse].sort((a, b) => {
                const balA = parseFloat(a.premium_clast_month_ending_balance || 0);
                const balB = parseFloat(b.premium_clast_month_ending_balance || 0);
                if(sortMode === 'balanceDesc') return balB - balA;
                if(sortMode === 'balanceAsc') return balA - balB;
                return 0; // Default date sort implies input order roughly
            }).slice(0, 50); // Limit to 50

            sorted.forEach(row => {
                const tr = document.createElement('tr');
                
                // Status Logic
                let statusClass = 'bg-green-100 text-green-800';
                if((row.enrollment_status || '').toLowerCase().includes('cancel')) statusClass = 'bg-red-100 text-red-800';
                if(parseFloat(row.premium_ceom_total_due) > 0) statusClass = 'bg-amber-100 text-amber-800';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${row.enrollment_account_key || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${row.enrollment_city || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${row.enrollment_splan_code || row.enrollment_scard_plan || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${row.enrollment_date_report_created || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-slate-900">$${parseFloat(row.premium_clast_month_ending_balance || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-slate-500">$${parseFloat(row.premium_ceom_total_due || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${row.enrollment_status || 'Unknown'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 5. CSV Parser ---
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const result = [];
            for(let i=1; i<lines.length; i++) {
                // Simple regex to handle commas inside quotes would be better, but for this dataset simple split usually suffices
                // Or a robust split:
                const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                if(row.length === headers.length) {
                    const obj = {};
                    headers.forEach((h, index) => {
                        obj[h] = row[index] ? row[index].replace(/^"|"$/g, '') : '';
                    });
                    result.push(obj);
                }
            }
            return result;
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                rawData = parseCSV(text);
                processData(rawData);
            };
            reader.readAsText(file);
        }

        function loadDemoData() {
            rawData = generateDemoData();
            processData(rawData);
        }

        // --- 6. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            // Load Demo Data by default for immediate "Wow"
            loadDemoData();
        });

    </script>
</body>
</html>
